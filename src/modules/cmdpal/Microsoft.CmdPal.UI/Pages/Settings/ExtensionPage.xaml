<?xml version="1.0" encoding="utf-8" ?>
<Page
    x:Class="Microsoft.CmdPal.UI.Pages.ExtensionPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:cmdpalUI="using:Microsoft.CmdPal.UI"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    xmlns:converters="using:CommunityToolkit.WinUI.Converters"
    xmlns:cpcontrols="using:Microsoft.CmdPal.UI.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:helpers="using:Microsoft.CmdPal.UI.Helpers"
    xmlns:local="using:Microsoft.CmdPal.UI.Pages"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="using:CommunityToolkit.WinUI"
    xmlns:viewmodels="using:Microsoft.CmdPal.UI.ViewModels"
    mc:Ignorable="d">

    <Page.Resources>
        <ResourceDictionary>
            <converters:StringVisibilityConverter
                x:Key="StringNotEmptyToVisibilityConverter"
                EmptyValue="Collapsed"
                NotEmptyValue="Visible" />
            <converters:StringVisibilityConverter
                x:Key="InvertedStringEmptyVisibilityConverter"
                EmptyValue="Visible"
                NotEmptyValue="Collapsed" />

            <converters:BoolToVisibilityConverter
                x:Key="BoolToInvertedVisibilityConverter"
                FalseValue="Visible"
                TrueValue="Collapsed" />
        </ResourceDictionary>
    </Page.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <ScrollViewer Grid.Row="1" Padding="0,0,8,0">
            <Grid Padding="8,-8,8,8">
                <StackPanel
                    MaxWidth="1000"
                    HorizontalAlignment="Stretch"
                    Spacing="{StaticResource SettingsCardSpacing}">

                    <TextBlock x:Uid="ExtensionCommandsHeader" Style="{StaticResource SettingsSectionHeaderTextBlockStyle}" />

                    <ItemsRepeater 
                        ItemsSource="{x:Bind ViewModel.TopLevelCommands, Mode=OneWay}" 
                        Layout="{StaticResource VerticalStackLayout}">
                        <ItemsRepeater.ItemTemplate>
                            <DataTemplate x:DataType="viewmodels:TopLevelViewModel">
                                <controls:SettingsExpander 
                                    Header="{x:Bind Title, Mode=OneWay}"
                                    Description="{x:Bind Subtitle, Mode=OneWay}"
                                    
                        IsExpanded="True"
                                    DataContext="{x:Bind}">
                                    <controls:SettingsExpander.HeaderIcon>
                                        <IconSourceElement x:Name="Ico"></IconSourceElement>
                                    </controls:SettingsExpander.HeaderIcon>
                                    <!--
                                        What we're doing here is 90% stupid.
                                        
                                        The SettingsCard APIs only explicitly allow an
                                        Icon as the content for the HeaderIcon property.
                                        We of course, have to do the goofy async IconBox thing.
                                        
                                        To manage this, we have to basically re-create
                                        the layout of the SettingsCard HeaderIcon,
                                        Header & Description, all within the Content.
                                        
                                        Most of what follows is lifted directly from
                                        https://github.com/CommunityToolkit/Windows/blob/main/components/SettingsControls/src/SettingsCard/SettingsCard.xaml
                                    -->
                                    <Grid
                                        Visibility="Collapsed"
                                        Margin="0,-12,0,0"
                                        HorizontalAlignment="Stretch"
                                        VerticalAlignment="Top">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="*" />
                                            <RowDefinition Height="Auto" />
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto" MinWidth="0" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>

                                        <Viewbox
                                            Grid.RowSpan="1"
                                            MaxWidth="20"
                                            MaxHeight="20"
                                            Margin="2,0,20,0">
                                            <cpcontrols:IconBox
                                                Width="20"
                                                Height="20"
                                                Margin="0,0,0,0"
                                                TargetIcon="{Binding ElementName=Ico}"
                                                AutomationProperties.AccessibilityView="Raw"
                                                SourceKey="{x:Bind Icon, Mode=OneWay}"
                                                SourceRequested="{x:Bind helpers:IconCacheProvider.SourceRequested}" />
                                        </Viewbox>

                                        <!--<StackPanel
                                            Grid.Column="1"
                                            Margin="0,0,24,0"
                                            VerticalAlignment="Top"
                                            Orientation="Vertical">
                                            <ContentPresenter
                                                Grid.Column="1"
                                                HorizontalAlignment="Left"
                                                Content="{x:Bind Title, Mode=OneWay}"
                                                HighContrastAdjustment="None"
                                                TextWrapping="Wrap" />

                                            <ContentPresenter
                                                Content="{x:Bind Subtitle, Mode=OneWay}"
                                                FontSize="12"
                                                Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                TextWrapping="Wrap" />
                                            <Border Height="6" Visibility="{x:Bind Subtitle, Mode=OneWay, Converter={StaticResource InvertedStringEmptyVisibilityConverter}}" />
                                        </StackPanel>-->

                                        <!--
                                            Because of this insane XAML thing we're
                                            doing, we can't effectively put content
                                            here on the right. Sad.
                                        -->

                                    </Grid>


                                    <controls:SettingsExpander.Items>
                                        <controls:SettingsCard
                                            Description="Directly open Command Palette to this command"
                                            Header="Global hotkey"
                                            HeaderIcon="{ui:FontIcon Glyph=&#xEDA7;}">
                                            <cpcontrols:ShortcutControl HotkeySettings="{x:Bind Hotkey, Mode=TwoWay}" />
                                        </controls:SettingsCard>
                                    </controls:SettingsExpander.Items>
                                </controls:SettingsExpander>
                            </DataTemplate>
                        </ItemsRepeater.ItemTemplate>
                    </ItemsRepeater>
                    <TextBlock
                        x:Uid="ExtensionSettingsHeader"
                        Style="{StaticResource SettingsSectionHeaderTextBlockStyle}"
                        Visibility="{x:Bind ViewModel.HasSettings}" />

                    <Frame x:Name="SettingsFrame" Visibility="{x:Bind ViewModel.HasSettings}">
                        <cmdpalUI:ContentPage ViewModel="{x:Bind ViewModel.SettingsPage, Mode=OneWay}" />
                    </Frame>

                    <TextBlock x:Uid="ExtensionAboutHeader" Style="{StaticResource SettingsSectionHeaderTextBlockStyle}" />

                    <controls:SettingsCard
                        Description="{x:Bind ViewModel.Extension.Publisher, Mode=OneWay}"
                        Header="{x:Bind ViewModel.Extension.PackageDisplayName, Mode=OneWay}"
                        Visibility="{x:Bind ViewModel.IsFromExtension, Mode=OneWay}">
                        <TextBlock
                            Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                            IsTextSelectionEnabled="True"
                            Text="{x:Bind ViewModel.ExtensionVersion}" />
                    </controls:SettingsCard>

                    <controls:SettingsCard
                        Description="These commands are built-in to the Windows Command Palette"
                        Header="Built-in"
                        Visibility="{x:Bind ViewModel.IsFromExtension, Mode=OneWay, Converter={StaticResource BoolToInvertedVisibilityConverter}}" />

                </StackPanel>
            </Grid>
        </ScrollViewer>
    </Grid>
</Page>
